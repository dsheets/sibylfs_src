@type trace
# open test that checks that we are not allowed
# to make parent timestamps go back in time when we call open [CREAT,RDWR]

Pid 1 -> mkdir /empty_dir_1/ 0o777
Tau
Pid 1 <- -

Pid 1 -> mkdir /empty_dir_2/ 0o777
Tau
Pid 1 <- -

Pid 1 -> mkdir /nonempty_dir_1/ 0o777
Tau
Pid 1 <- -

# end of state setup

Pid 1 -> stat /nonempty_dir_1/
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=0;st_gid=0;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=1;}; st_mtim={ tv_sec=0;tv_nsec=1;};st_ctim={ tv_sec=0;tv_nsec=1;};}

Pid 1 -> open /nonempty_dir_1/f2.txt [O_CREAT] 0o666
Tau
Pid 1 <- -

# open sets all the timestamps of the file (see OPEN_TS:1.1 in fs_spec/posix/open.md)

Pid 1 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=0;st_gid=0;st_rdev=0;st_size=0;st_atim={tv_sec=1;tv_nsec=0;}; st_mtim={ tv_sec=1;tv_nsec=0;};st_ctim={ tv_sec=1;tv_nsec=0;};}


# with the flag O_CREAT the st_ctime and the st_mtime
#  of the parent directory are altered (see OPEN_TS:1.2 in fs_spec/posix/open.md)

Pid 1 -> stat /nonempty_dir_1/
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=0;st_gid=0;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=1;}; st_mtim={ tv_sec=1;tv_nsec=0;};st_ctim={ tv_sec=1;tv_nsec=0;};}


Pid 1 -> open /nonempty_dir_1/f2.txt [O_TRUNC;O_RDWR] 0o666
Tau
Pid 1 <- -

# with O_TRUNC and O_RDWR flags st_ctime and st_mtime of the file should be altered (see OPEN_TS:2 in fs_spec/posix/open.md)

Pid 1 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=0;st_gid=0;st_rdev=0;st_size=0;st_atim={tv_sec=1;tv_nsec=0;}; st_mtim={ tv_sec=4;tv_nsec=0;};st_ctim={ tv_sec=4;tv_nsec=0;};}

# with the flag O_TRUNC no parent directory timestamp should be altered
Pid 1 -> stat /nonempty_dir_1/
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=0;st_gid=0;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=1;}; st_mtim={ tv_sec=1;tv_nsec=0;};st_ctim={ tv_sec=1;tv_nsec=0;};}

Pid 1 -> open /nonempty_dir_1/f2.txt [O_TRUNC;O_WRONLY] 0o666
Tau
Pid 1 <- -

# with O_TRUNC and O_WRONLY flags st_ctime and st_mtime of the file should be altered

Pid 1 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=0;st_gid=0;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

Pid 1 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=0;st_gid=0;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

# with the flag O_TRUNC no parent directory timestamp should be altered

Pid 1 -> stat /nonempty_dir_1/
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=0;st_gid=0;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

Pid 1 -> stat /nonempty_dir_1/
Tau
Pid 1 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=0;st_gid=0;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}
