@type trace

# concurrent symlink tests about timestamp assignment in an immediate architecture

Pid 2 -> create User_id 2 Group_id 2
Pid 3 -> create User_id 2 Group_id 2
Pid 4 -> create User_id 2 Group_id 2

Pid 1 -> add_user_to_group User_id 2 Group_id 2
Tau
Pid 1 <- -

Pid 2 -> mkdir /nonempty_dir_1/ 0o777
Tau
Pid 2 <- -

Pid 2 -> open /nonempty_dir_1/f2.txt [O_CREAT;O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2 -> open /nonempty_dir_1/f3.txt [O_CREAT;O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2 -> open /nonempty_dir_1/f4.txt [O_CREAT;O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f3.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f4.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=2;st_gid=2;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

# end of state setup

dump-internal

## test truncate timestamps with unmodified files

Pid 2 -> truncate /nonempty_dir_1/f2.txt 0
Pid 3 -> truncate /nonempty_dir_1/f3.txt 0
Pid 4 -> truncate /nonempty_dir_1/f4.txt 0
Tau
Tau
Tau
Pid 2 <- -
Pid 4 <- -
Pid 3 <- -

dump-internal

Pid 2 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f3.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f4.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=0;tv_nsec=0;};st_ctim={tv_sec=0;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=2;st_gid=2;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

## test truncate timestamps after modifing files

Pid 2 -> open /nonempty_dir_1/f2.txt [O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2 -> write! (FD 3) "alphaomega" 10
Tau
Pid 2 <- -

Pid 2 -> close (FD 3)
Tau
Pid 2 <- -

Pid 2 -> open /nonempty_dir_1/f3.txt [O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2-> write! (FD 3) "alphaomega" 10
Tau
Pid 2 <- -

Pid 2 -> close (FD 3)
Tau
Pid 2 <- -

Pid 2 -> open /nonempty_dir_1/f4.txt [O_RDWR] 0o666
Tau
Pid 2 <- -

Pid 2 -> write! (FD 3) "alphaomega" 10
Tau
Pid 2 <- -

Pid 2 -> close (FD 3)
Tau
Pid 2 <- -

dump-internal

Pid 2 -> truncate /nonempty_dir_1/f2.txt 0
Pid 3 -> truncate /nonempty_dir_1/f3.txt 0
Pid 4 -> truncate /nonempty_dir_1/f4.txt 0
Tau
Tau
Tau
Pid 2 <- -
Pid 4 <- -
Pid 3 <- -

dump-internal

Pid 2 -> stat /nonempty_dir_1/f2.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=2;tv_nsec=0;};st_ctim={tv_sec=2;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f3.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=2;tv_nsec=0;};st_ctim={tv_sec=2;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/f4.txt
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=2;st_kind=S_IFREG;st_perm=0o644;st_nlink=1;st_uid=2;st_gid=2;st_rdev=0;st_size=0;st_atim={tv_sec=0;tv_nsec=0;};st_mtim={tv_sec=2;tv_nsec=0;};st_ctim={tv_sec=2;tv_nsec=0;};}

Pid 2 -> stat /nonempty_dir_1/
Tau
Pid 2 <- RV_stat {st_dev=2049;st_ino=1;st_kind=S_IFDIR;st_perm=0o755;st_nlink=2;st_uid=2;st_gid=2;st_rdev=0;st_size=4096;st_atim={tv_sec=0;tv_nsec=0;}; st_mtim={ tv_sec=0;tv_nsec=0;};st_ctim={ tv_sec=0;tv_nsec=0;};}

dump-internal
